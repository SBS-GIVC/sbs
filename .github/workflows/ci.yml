name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Code Quality & Linting
  # ============================================================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python linters
        run: |
          pip install flake8 black isort mypy

      - name: Detect changed Python files
        id: changed-python
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          if [ -z "${BASE_SHA}" ] || [ "${BASE_SHA}" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD)"
          fi

          CHANGED_PY_FILES="$(git diff --name-only "${BASE_SHA}" "${{ github.sha }}" | grep -E '^(normalizer-service|signer-service|financial-rules-engine|nphies-bridge|tests)/.*\.py$' || true)"

          if [ -n "${CHANGED_PY_FILES}" ]; then
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            {
              echo "files<<EOF"
              echo "${CHANGED_PY_FILES}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "Changed Python files:"
            echo "${CHANGED_PY_FILES}"
          else
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            echo "No changed Python files in lint scope."
          fi

      - name: Run Python linting
        if: steps.changed-python.outputs.has_files == 'true'
        run: |
          # Check only changed Python files to avoid failing unrelated deploys on legacy lint debt.
          flake8 --max-line-length=120 --ignore=E501,W503,E302,E305,F401,F841,W291,W293 \
            --exclude=__pycache__,.venv,venv \
            ${{ steps.changed-python.outputs.files }}

      - name: Skip Python linting (no relevant changes)
        if: steps.changed-python.outputs.has_files != 'true'
        run: echo "Skipping flake8 because no Python files changed in service/test directories."

      - name: Check Python formatting with Black
        run: |
          black --check --diff \
            normalizer-service/ \
            signer-service/ \
            financial-rules-engine/ \
            nphies-bridge/ \
            tests/ || true

      - name: Install Node.js dependencies
        working-directory: sbs-landing
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Run ESLint (if configured)
        working-directory: sbs-landing
        run: npm run lint || echo "ESLint not fully configured, skipping..."
        continue-on-error: true

  # ============================================================================
  # Python Microservices Tests
  # ============================================================================
  test-python:
    name: Test Python Services
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        service:
          - normalizer-service
          - signer-service
          - financial-rules-engine
          - nphies-bridge
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ matrix.service }}/requirements.txt

      - name: Install dependencies
        run: |
          cd ${{ matrix.service }}
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run unit tests
        run: |
          cd ${{ matrix.service }}
          # Run tests if they exist, otherwise skip gracefully (not all services have tests yet)
          if find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
            set +e
            python -m pytest --cov=. --cov-report=xml --cov-report=term-missing -v
            TEST_EXIT=$?
            set -e
            if [ "${TEST_EXIT}" -eq 5 ]; then
              echo "‚ö†Ô∏è No tests collected for ${{ matrix.service }} - skipping"
              exit 0
            fi
            exit "${TEST_EXIT}"
          else
            echo "‚ö†Ô∏è No tests found for ${{ matrix.service }} - skipping"
          fi

      - name: Verify service can start
        run: |
          cd ${{ matrix.service }}
          timeout 10s python -c "from main import app; print('‚úÖ Service imports successfully')" || echo "Import check completed"

  # ============================================================================
  # Node.js Backend Tests
  # ============================================================================
  test-node:
    name: Test Node.js Backend
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sbs-landing/package-lock.json

      - name: Install dependencies
        working-directory: sbs-landing
        run: npm ci || npm install

      - name: Run tests
        working-directory: sbs-landing
        run: npm test

      - name: Verify server can start
        working-directory: sbs-landing
        run: |
          timeout 10s node -e "
            const app = require('./server.cjs');
            console.log('‚úÖ Server module loads successfully');
            process.exit(0);
          " || echo "Server verification completed"

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-node]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          pip install -r tests/requirements.txt

      - name: Run integration tests (mocked)
        run: |
          cd tests
          python -m pytest test_normalizer_comprehensive.py test_signer_comprehensive.py -v --tb=short

  # ============================================================================
  # E2E Tests (Playwright)
  # ============================================================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-node]
    continue-on-error: true
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python test dependencies
        run: |
          pip install -r tests/requirements.txt
          pip install playwright
          playwright install chromium
          playwright install-deps

      - name: Install Node.js dependencies
        working-directory: sbs-landing
        run: npm ci || npm install

      - name: Start backend server
        working-directory: sbs-landing
        run: |
          ENABLE_MOCK_PROCESSING=true npm start &
          sleep 5
        env:
          PORT: 3000
          NODE_ENV: test

      - name: Run E2E tests
        run: |
          cd tests
          python -m pytest e2e/ -v --tb=short -x
        env:
          SBS_BASE_URL: http://localhost:3000
          SBS_API_URL: http://localhost:3000
          HEADLESS: true

  # ============================================================================
  # Docker Build Verification
  # ============================================================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test-python, test-node]  # Build only after tests pass
    strategy:
      matrix:
        service:
          - name: normalizer-service
            context: ./normalizer-service
          - name: signer-service
            context: ./signer-service
          - name: financial-rules-engine
            context: ./financial-rules-engine
          - name: nphies-bridge
            context: ./nphies-bridge
          - name: sbs-landing
            context: ./sbs-landing
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          push: false
          tags: sbs/${{ matrix.service.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install security scanners
        run: |
          pip install safety bandit

      - name: Run Bandit (Python security linter)
        run: |
          bandit -r normalizer-service/ signer-service/ financial-rules-engine/ nphies-bridge/ \
            -ll -ii --skip B101 || echo "Bandit scan completed"
        continue-on-error: true

      - name: Run Safety (Python dependency checker)
        run: |
          for dir in normalizer-service signer-service financial-rules-engine nphies-bridge; do
            echo "Checking $dir..."
            pip install -r $dir/requirements.txt -q
            safety check --full-report || true
          done
        continue-on-error: true

      - name: Run npm audit
        working-directory: sbs-landing
        run: |
          npm ci || npm install
          npm audit --audit-level=high || echo "npm audit completed"
        continue-on-error: true

  # ============================================================================
  # Build Summary
  # ============================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, test-python, test-node, docker-build, security-scan]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "## üèóÔ∏è CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Tests | ${{ needs.test-node.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: needs.lint.result == 'failure' || needs.docker-build.result == 'failure'
        run: |
          echo "‚ùå Critical jobs failed!"
          exit 1
