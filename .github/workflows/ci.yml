name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Code Quality & Linting
  # ============================================================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python linters
        run: |
          pip install flake8 black isort mypy

      - name: Run Python linting
        run: |
          # Check code style with flake8
          flake8 --max-line-length=120 --ignore=E501,W503 \
            normalizer-service/ \
            signer-service/ \
            financial-rules-engine/ \
            nphies-bridge/ \
            tests/ \
            --exclude=__pycache__,.venv,venv

      - name: Check Python formatting with Black
        run: |
          black --check --diff \
            normalizer-service/ \
            signer-service/ \
            financial-rules-engine/ \
            nphies-bridge/ \
            tests/ || true

      - name: Install Node.js dependencies
        working-directory: sbs-landing
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Run ESLint (if configured)
        working-directory: sbs-landing
        run: npm run lint || echo "ESLint not fully configured, skipping..."
        continue-on-error: true

  # ============================================================================
  # Python Microservices Tests
  # ============================================================================
  test-python:
    name: Test Python Services
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        service:
          - normalizer-service
          - signer-service
          - financial-rules-engine
          - nphies-bridge
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ${{ matrix.service }}/requirements.txt

      - name: Install dependencies
        run: |
          cd ${{ matrix.service }}
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run unit tests
        run: |
          cd ${{ matrix.service }}
          python -m pytest --cov=. --cov-report=xml --cov-report=term-missing -v || echo "No tests found for ${{ matrix.service }}"
        continue-on-error: true

      - name: Verify service can start
        run: |
          cd ${{ matrix.service }}
          timeout 10s python -c "from main import app; print('‚úÖ Service imports successfully')" || echo "Import check completed"

  # ============================================================================
  # Node.js Backend Tests
  # ============================================================================
  test-node:
    name: Test Node.js Backend
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: sbs-landing/package-lock.json

      - name: Install dependencies
        working-directory: sbs-landing
        run: npm ci || npm install

      - name: Run tests
        working-directory: sbs-landing
        run: npm test || echo "Basic test completed"
        continue-on-error: true

      - name: Verify server can start
        working-directory: sbs-landing
        run: |
          timeout 10s node -e "
            const app = require('./server.js');
            console.log('‚úÖ Server module loads successfully');
            process.exit(0);
          " || echo "Server verification completed"

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-node]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          pip install -r tests/requirements.txt

      - name: Run integration tests (mocked)
        run: |
          cd tests
          python -m pytest test_normalizer.py test_signer.py -v --tb=short || echo "Integration tests completed"
        continue-on-error: true

  # ============================================================================
  # E2E Tests (Playwright)
  # ============================================================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-node]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python test dependencies
        run: |
          pip install -r tests/requirements.txt
          playwright install chromium
          playwright install-deps

      - name: Install Node.js dependencies
        working-directory: sbs-landing
        run: npm ci || npm install

      - name: Start backend server
        working-directory: sbs-landing
        run: |
          ENABLE_MOCK_PROCESSING=true npm start &
          sleep 5
        env:
          PORT: 3000
          NODE_ENV: test

      - name: Run E2E tests
        run: |
          cd tests
          python -m pytest e2e/ -v --tb=short -x || echo "E2E tests completed"
        env:
          SBS_BASE_URL: http://localhost:3000
          SBS_API_URL: http://localhost:3000
          HEADLESS: true
        continue-on-error: true

  # ============================================================================
  # Docker Build Verification
  # ============================================================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        service:
          - name: normalizer-service
            context: ./normalizer-service
          - name: signer-service
            context: ./signer-service
          - name: financial-rules-engine
            context: ./financial-rules-engine
          - name: nphies-bridge
            context: ./nphies-bridge
          - name: sbs-landing
            context: ./sbs-landing
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          push: false
          tags: sbs/${{ matrix.service.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install security scanners
        run: |
          pip install safety bandit

      - name: Run Bandit (Python security linter)
        run: |
          bandit -r normalizer-service/ signer-service/ financial-rules-engine/ nphies-bridge/ \
            -ll -ii --skip B101 || echo "Bandit scan completed"
        continue-on-error: true

      - name: Run Safety (Python dependency checker)
        run: |
          for dir in normalizer-service signer-service financial-rules-engine nphies-bridge; do
            echo "Checking $dir..."
            pip install -r $dir/requirements.txt -q
            safety check --full-report || true
          done
        continue-on-error: true

      - name: Run npm audit
        working-directory: sbs-landing
        run: |
          npm ci || npm install
          npm audit --audit-level=high || echo "npm audit completed"
        continue-on-error: true

  # ============================================================================
  # Build Summary
  # ============================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, test-python, test-node, docker-build, security-scan]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "## üèóÔ∏è CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Tests | ${{ needs.test-node.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: needs.lint.result == 'failure' || needs.docker-build.result == 'failure'
        run: |
          echo "‚ùå Critical jobs failed!"
          exit 1
