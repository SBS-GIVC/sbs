import{a as u}from"./vendor-hzXslIYo.js";const p=typeof window<"u"&&window.SBS_API_URL?String(window.SBS_API_URL).replace(/\/+$/,""):typeof window<"u"&&window.location?.origin?String(window.location.origin).replace(/\/+$/,""):"",d={baseUrl:"https://sandbox.nphies.sa/api/v1",timeout:3e4};class g{constructor(){this.client=u.create({baseURL:d.baseUrl,timeout:d.timeout,headers:{"Content-Type":"application/fhir+json",Accept:"application/fhir+json"}}),this.accessToken=null,this.tokenExpiry=null}async postLanding(e,a,t=12e3){const r=new AbortController,n=setTimeout(()=>r.abort(),t);try{const i=await fetch(`${p}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a||{}),signal:r.signal}),o=await i.json().catch(()=>({}));if(!i.ok)throw new Error(o?.error||`HTTP ${i.status}`);return o}finally{clearTimeout(n)}}normalizeLandingBenefits(e,a){const t={};if(Array.isArray(e))e.forEach((r,n)=>{const i=String(r||`benefit_${n+1}`).toLowerCase().replace(/[^a-z0-9]+/g,"_");t[i]={category:i,name:String(r||i),allowed:1e4,used:0,remaining:1e4}});else if(e&&typeof e=="object")for(const[r,n]of Object.entries(e))t[r]={category:r,name:n?.name||r,allowed:Number(n?.allowed||1e4),used:Number(n?.used||0),remaining:Number(n?.remaining||Number(n?.allowed||1e4)-Number(n?.used||0))};if(a&&typeof a=="object"){for(const[r,n]of Object.entries(a))if(!t[r]){const i=Number(String(n).replace("%",""))||0,o=1e4,c=Math.round(i/100*o);t[r]={category:r,name:r.replace(/_/g," "),allowed:o,used:Math.max(0,o-c),remaining:c}}}return Object.keys(t).length===0&&(t.general={category:"general",name:"General",allowed:1e4,used:0,remaining:1e4}),t}async authenticate(){if(this.accessToken&&this.tokenExpiry>Date.now())return this.accessToken;try{return this.accessToken="sandbox-demo-token",this.tokenExpiry=Date.now()+36e5,this.accessToken}catch(e){throw console.error("NPHIES authentication failed:",e),new Error("Authentication failed")}}async setAuthHeader(){const e=await this.authenticate();this.client.defaults.headers.Authorization=`Bearer ${e}`}async checkEligibility({patientId:e,insurerId:a,policyNumber:t,serviceDate:r}){try{const i=await this.postLanding("/api/eligibility/check",{memberId:e,payerId:a,dateOfService:r||new Date().toISOString().split("T")[0],policyNumber:t});return{eligible:!!i.eligible,status:i.eligible?"active":"inactive",patientId:e,policyNumber:t||`POL-${e}-${new Date().getFullYear()}`,coverageStart:`${new Date().getFullYear()}-01-01`,coverageEnd:`${new Date().getFullYear()}-12-31`,payerName:i.plan||"SBS Standard Plus",payerId:a||"INS-AUTO",className:i.eligible?"Standard Plus":"Review Required",benefits:this.normalizeLandingBenefits(i.benefits,i.coverage),coPayPercentage:i.eligible?20:100,deductible:i.eligible?500:0,deductibleMet:!1,source:i.source||"landing-proxy",notes:i.notes?[i.notes]:[],errors:[]}}catch(i){console.warn("Eligibility proxy unavailable, falling back to NPHIES/mock:",i?.message||i)}await this.setAuthHeader();const n=this.buildEligibilityRequest({patientId:e,insurerId:a,policyNumber:t,serviceDate:r||new Date().toISOString().split("T")[0]});try{const i=await this.client.post("/CoverageEligibilityRequest",n);return this.parseEligibilityResponse(i.data)}catch(i){return console.error("Eligibility check failed:",i),this.getMockEligibility(e)}}buildEligibilityRequest({patientId:e,insurerId:a,policyNumber:t,serviceDate:r}){return{resourceType:"CoverageEligibilityRequest",id:`eligibility-${Date.now()}`,status:"active",purpose:["validation","benefits"],patient:{reference:`Patient/${e}`},servicedDate:r,created:new Date().toISOString(),insurer:{reference:`Organization/${a}`},insurance:[{focal:!0,coverage:{reference:`Coverage/${t}`}}]}}parseEligibilityResponse(e){return{eligible:e.outcome==="complete",status:e.outcome,policyNumber:e.insurance?.[0]?.coverage?.reference?.split("/")[1],coverageStart:e.insurance?.[0]?.benefitPeriod?.start,coverageEnd:e.insurance?.[0]?.benefitPeriod?.end,benefits:this.extractBenefits(e.insurance?.[0]?.item||[]),errors:e.error?.map(a=>a.code?.text)||[]}}extractBenefits(e){const a={};return e.forEach(t=>{const r=t.category?.coding?.[0]?.code||"general";a[r]={category:r,name:t.category?.coding?.[0]?.display,allowed:t.benefit?.find(n=>n.type?.coding?.[0]?.code==="benefit")?.allowedMoney?.value,used:t.benefit?.find(n=>n.type?.coding?.[0]?.code==="benefit")?.usedMoney?.value,remaining:null},a[r].allowed&&a[r].used&&(a[r].remaining=a[r].allowed-a[r].used)}),a}getMockEligibility(e){return{eligible:!0,status:"active",patientId:e,policyNumber:`POL-${e}-2026`,coverageStart:"2026-01-01",coverageEnd:"2026-12-31",payerName:"Bupa Arabia",payerId:"INS-BUPA-001",className:"VIP",benefits:{inpatient:{category:"inpatient",name:"Inpatient Services",allowed:5e5,used:45e3,remaining:455e3},outpatient:{category:"outpatient",name:"Outpatient Services",allowed:5e4,used:5200,remaining:44800},dental:{category:"dental",name:"Dental Services",allowed:1e4,used:0,remaining:1e4},optical:{category:"optical",name:"Optical Services",allowed:5e3,used:0,remaining:5e3},maternity:{category:"maternity",name:"Maternity Coverage",allowed:3e4,used:0,remaining:3e4}},coPayPercentage:20,deductible:500,deductibleMet:!0,errors:[]}}async submitPriorAuth({patientId:e,facilityId:a,sbsCode:t,diagnosis:r,description:n,estimatedAmount:i,expectedDate:o}){try{const s=await this.postLanding("/api/prior-auth/submit",{memberId:e,procedureCode:t,diagnosis:r,description:n,estimatedAmount:i,expectedDate:o,facilityId:a}),l={approved:"approved",pending_review:"pending",pending:"pending",denied:"denied",rejected:"denied"}[String(s.status||"").toLowerCase()]||"pending";return{authNumber:s.authId||`PA-${Date.now()}`,status:l,sbsCode:t,approvedAmount:l==="approved"?Number(i||0):null,validFrom:new Date().toISOString().split("T")[0],validUntil:new Date(Date.now()+(l==="approved"?30:2)*24*60*60*1e3).toISOString().split("T")[0],notes:s.notes?[s.notes]:[],denialReason:l==="denied"?s.notes||"Denied by policy review":null}}catch(s){console.warn("Prior auth proxy unavailable, falling back to NPHIES/mock:",s?.message||s)}await this.setAuthHeader();const c=this.buildPriorAuthRequest({patientId:e,facilityId:a,sbsCode:t,diagnosis:r,description:n,estimatedAmount:i,expectedDate:o});try{const s=await this.client.post("/Claim",c);return this.parsePriorAuthResponse(s.data)}catch(s){return console.error("Prior auth submission failed:",s),this.getMockPriorAuth(t)}}buildPriorAuthRequest({patientId:e,facilityId:a,sbsCode:t,diagnosis:r,description:n,estimatedAmount:i,expectedDate:o}){return{resourceType:"Claim",id:`pa-${Date.now()}`,status:"active",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/claim-type",code:"institutional"}]},use:"preauthorization",patient:{reference:`Patient/${e}`},created:new Date().toISOString(),provider:{reference:`Organization/${a}`},priority:{coding:[{code:"normal"}]},diagnosis:r?[{sequence:1,diagnosisCodeableConcept:{coding:[{system:"http://hl7.org/fhir/sid/icd-10",code:r}]}}]:[],item:[{sequence:1,productOrService:{coding:[{system:"http://chi.gov.sa/sbs",code:t,display:n}]},servicedDate:o||new Date().toISOString().split("T")[0],unitPrice:{value:i,currency:"SAR"}}],total:{value:i,currency:"SAR"}}}parsePriorAuthResponse(e){const a=e.outcome||"pending";return{authNumber:e.preAuthRef||`PA-${Date.now()}`,status:a==="complete"?"approved":a==="error"?"denied":"pending",approvedAmount:e.payment?.amount?.value,validFrom:e.preAuthPeriod?.start,validUntil:e.preAuthPeriod?.end,notes:e.processNote?.map(t=>t.text),denialReason:a==="error"?e.error?.[0]?.code?.text:null}}getMockPriorAuth(e){const a=Math.random()>.2;return{authNumber:`PA-2026-${Math.random().toString(36).substring(7).toUpperCase()}`,status:a?"approved":"pending",sbsCode:e,approvedAmount:a?Math.floor(Math.random()*5e4)+1e4:null,validFrom:new Date().toISOString().split("T")[0],validUntil:new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],notes:a?["Pre-authorization approved. Valid for 30 days."]:["Under review. Expected decision within 48 hours."],denialReason:null}}async checkPriorAuthStatus(e){await this.setAuthHeader();try{const a=await this.client.get(`/Claim?identifier=${e}`);return this.parsePriorAuthResponse(a.data.entry?.[0]?.resource)}catch(a){return console.error("Prior auth status check failed:",a),this.getMockPriorAuth(e)}}async submitClaim(e){await this.setAuthHeader();const a=this.buildClaimResource(e);try{const t=await this.client.post("/Claim",a);return this.parseClaimResponse(t.data)}catch(t){return console.error("Claim submission failed:",t),this.getMockClaimResponse(e)}}buildClaimResource(e){const a=e.items.map((t,r)=>({sequence:r+1,productOrService:{coding:[{system:"http://chi.gov.sa/sbs",code:t.sbsCode,display:t.description}]},servicedDate:t.serviceDate||e.serviceDate,quantity:{value:t.quantity||1},unitPrice:{value:t.unitPrice,currency:"SAR"},net:{value:t.netPrice||t.unitPrice*(t.quantity||1),currency:"SAR"}}));return{resourceType:"Claim",id:e.claimNumber||`CLM-${Date.now()}`,status:"active",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/claim-type",code:e.claimType||"institutional"}]},use:"claim",patient:{reference:`Patient/${e.patientId}`},created:new Date().toISOString(),provider:{reference:`Organization/${e.facilityId}`},priority:{coding:[{code:"normal"}]},insurance:[{sequence:1,focal:!0,coverage:{reference:`Coverage/${e.policyNumber}`}}],diagnosis:e.diagnoses?.map((t,r)=>({sequence:r+1,diagnosisCodeableConcept:{coding:[{system:"http://hl7.org/fhir/sid/icd-10",code:t.code,display:t.display}]}}))||[],item:a,total:{value:e.totalAmount,currency:"SAR"}}}parseClaimResponse(e){return{claimId:e.id,nphiesReference:e.identifier?.[0]?.value,status:this.mapClaimStatus(e.outcome),totalSubmitted:e.total?.value,totalApproved:e.payment?.amount?.value,processedDate:e.created,items:e.item?.map(a=>({sequence:a.sequence,status:a.adjudication?.find(t=>t.category?.coding?.[0]?.code==="submitted")?.reason?.coding?.[0]?.code,approvedAmount:a.adjudication?.find(t=>t.category?.coding?.[0]?.code==="benefit")?.amount?.value,denialReason:a.adjudication?.find(t=>t.category?.coding?.[0]?.code==="denial")?.reason?.coding?.[0]?.display})),errors:e.error?.map(a=>a.code?.text)||[]}}mapClaimStatus(e){return{queued:"submitted",complete:"approved",error:"rejected",partial:"partially_approved"}[e]||"pending"}getMockClaimResponse(e){const a=["approved","pending","partially_approved"],t=a[Math.floor(Math.random()*a.length)];return{claimId:e.claimNumber||`CLM-${Date.now()}`,nphiesReference:`NPHIES-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`,status:t,totalSubmitted:e.totalAmount,totalApproved:t==="approved"?e.totalAmount:t==="partially_approved"?e.totalAmount*.85:null,processedDate:new Date().toISOString(),items:e.items?.map((r,n)=>({sequence:n+1,status:t==="approved"?"approved":"pending",approvedAmount:t==="approved"?r.netPrice:null,denialReason:null})),errors:[]}}async checkClaimStatus(e){await this.setAuthHeader();try{const a=await this.client.get(`/ClaimResponse?request=${e}`);return this.parseClaimResponse(a.data.entry?.[0]?.resource)}catch(a){return console.error("Claim status check failed:",a),{claimId:e,status:"pending",message:"Unable to retrieve status. Please try again later."}}}detectBundles(e){const a=this.getAvailableBundles(),t=[];return a.forEach(r=>{const n=r.requiredCodes.filter(o=>e.includes(o)),i=n.length/r.requiredCodes.length*100;i>=60&&t.push({...r,matchedCodes:n,matchPercentage:i,savings:this.calculateBundleSavings(e,r)})}),{hasApplicableBundles:t.length>0,bundles:t,recommendedBundle:t.sort((r,n)=>n.savings-r.savings)[0]||null}}getAvailableBundles(){return[{id:"BUNDLE-KNEE-REPLACE",name:"Total Knee Replacement Bundle",totalPrice:45e3,requiredCodes:["49518-00-00","49518-01-00","49519-00-00","92514-00-00","95550-00-00"],description:"Complete knee replacement package including surgery, implants, and rehabilitation"},{id:"BUNDLE-CARDIAC-CATH",name:"Cardiac Catheterization Bundle",totalPrice:25e3,requiredCodes:["38200-00-00","38203-00-00","38218-00-00","11700-00-00"],description:"Diagnostic cardiac catheterization with angiography"},{id:"BUNDLE-LAPCHOL",name:"Laparoscopic Cholecystectomy Bundle",totalPrice:15e3,requiredCodes:["30443-00-00","30445-00-00","92514-00-00"],description:"Gallbladder removal surgery package"},{id:"BUNDLE-APPENDIX",name:"Appendectomy Bundle",totalPrice:12e3,requiredCodes:["30571-00-00","30572-00-00","92514-00-00"],description:"Appendix removal surgery package"},{id:"BUNDLE-MATERNITY",name:"Normal Delivery Package",totalPrice:12e3,requiredCodes:["16520-00-00","16520-01-00","90761-00-00"],description:"Standard vaginal delivery with routine care"}]}calculateBundleSavings(e,a){const t=e.length*5e3;return Math.max(0,t-a.totalPrice)}}const v=new g;export{v as n};
//# sourceMappingURL=nphiesService-BO8lu4FP.js.map
