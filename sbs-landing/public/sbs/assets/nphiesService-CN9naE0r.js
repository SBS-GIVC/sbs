import{a as d}from"./vendor-BW1Bdpst.js";const c={baseUrl:"https://sandbox.nphies.sa/api/v1",timeout:3e4};class u{constructor(){this.client=d.create({baseURL:c.baseUrl,timeout:c.timeout,headers:{"Content-Type":"application/fhir+json",Accept:"application/fhir+json"}}),this.accessToken=null,this.tokenExpiry=null}async authenticate(){if(this.accessToken&&this.tokenExpiry>Date.now())return this.accessToken;try{return this.accessToken="sandbox-demo-token",this.tokenExpiry=Date.now()+36e5,this.accessToken}catch(e){throw console.error("NPHIES authentication failed:",e),new Error("Authentication failed")}}async setAuthHeader(){const e=await this.authenticate();this.client.defaults.headers.Authorization=`Bearer ${e}`}async checkEligibility({patientId:e,insurerId:t,policyNumber:a,serviceDate:i}){await this.setAuthHeader();const r=this.buildEligibilityRequest({patientId:e,insurerId:t,policyNumber:a,serviceDate:i||new Date().toISOString().split("T")[0]});try{const n=await this.client.post("/CoverageEligibilityRequest",r);return this.parseEligibilityResponse(n.data)}catch(n){return console.error("Eligibility check failed:",n),this.getMockEligibility(e)}}buildEligibilityRequest({patientId:e,insurerId:t,policyNumber:a,serviceDate:i}){return{resourceType:"CoverageEligibilityRequest",id:`eligibility-${Date.now()}`,status:"active",purpose:["validation","benefits"],patient:{reference:`Patient/${e}`},servicedDate:i,created:new Date().toISOString(),insurer:{reference:`Organization/${t}`},insurance:[{focal:!0,coverage:{reference:`Coverage/${a}`}}]}}parseEligibilityResponse(e){return{eligible:e.outcome==="complete",status:e.outcome,policyNumber:e.insurance?.[0]?.coverage?.reference?.split("/")[1],coverageStart:e.insurance?.[0]?.benefitPeriod?.start,coverageEnd:e.insurance?.[0]?.benefitPeriod?.end,benefits:this.extractBenefits(e.insurance?.[0]?.item||[]),errors:e.error?.map(t=>t.code?.text)||[]}}extractBenefits(e){const t={};return e.forEach(a=>{const i=a.category?.coding?.[0]?.code||"general";t[i]={category:i,name:a.category?.coding?.[0]?.display,allowed:a.benefit?.find(r=>r.type?.coding?.[0]?.code==="benefit")?.allowedMoney?.value,used:a.benefit?.find(r=>r.type?.coding?.[0]?.code==="benefit")?.usedMoney?.value,remaining:null},t[i].allowed&&t[i].used&&(t[i].remaining=t[i].allowed-t[i].used)}),t}getMockEligibility(e){return{eligible:!0,status:"active",patientId:e,policyNumber:`POL-${e}-2026`,coverageStart:"2026-01-01",coverageEnd:"2026-12-31",payerName:"Bupa Arabia",payerId:"INS-BUPA-001",className:"VIP",benefits:{inpatient:{category:"inpatient",name:"Inpatient Services",allowed:5e5,used:45e3,remaining:455e3},outpatient:{category:"outpatient",name:"Outpatient Services",allowed:5e4,used:5200,remaining:44800},dental:{category:"dental",name:"Dental Services",allowed:1e4,used:0,remaining:1e4},optical:{category:"optical",name:"Optical Services",allowed:5e3,used:0,remaining:5e3},maternity:{category:"maternity",name:"Maternity Coverage",allowed:3e4,used:0,remaining:3e4}},coPayPercentage:20,deductible:500,deductibleMet:!0,errors:[]}}async submitPriorAuth({patientId:e,facilityId:t,sbsCode:a,diagnosis:i,description:r,estimatedAmount:n,expectedDate:o}){await this.setAuthHeader();const l=this.buildPriorAuthRequest({patientId:e,facilityId:t,sbsCode:a,diagnosis:i,description:r,estimatedAmount:n,expectedDate:o});try{const s=await this.client.post("/Claim",l);return this.parsePriorAuthResponse(s.data)}catch(s){return console.error("Prior auth submission failed:",s),this.getMockPriorAuth(a)}}buildPriorAuthRequest({patientId:e,facilityId:t,sbsCode:a,diagnosis:i,description:r,estimatedAmount:n,expectedDate:o}){return{resourceType:"Claim",id:`pa-${Date.now()}`,status:"active",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/claim-type",code:"institutional"}]},use:"preauthorization",patient:{reference:`Patient/${e}`},created:new Date().toISOString(),provider:{reference:`Organization/${t}`},priority:{coding:[{code:"normal"}]},diagnosis:i?[{sequence:1,diagnosisCodeableConcept:{coding:[{system:"http://hl7.org/fhir/sid/icd-10",code:i}]}}]:[],item:[{sequence:1,productOrService:{coding:[{system:"http://chi.gov.sa/sbs",code:a,display:r}]},servicedDate:o||new Date().toISOString().split("T")[0],unitPrice:{value:n,currency:"SAR"}}],total:{value:n,currency:"SAR"}}}parsePriorAuthResponse(e){const t=e.outcome||"pending";return{authNumber:e.preAuthRef||`PA-${Date.now()}`,status:t==="complete"?"approved":t==="error"?"denied":"pending",approvedAmount:e.payment?.amount?.value,validFrom:e.preAuthPeriod?.start,validUntil:e.preAuthPeriod?.end,notes:e.processNote?.map(a=>a.text),denialReason:t==="error"?e.error?.[0]?.code?.text:null}}getMockPriorAuth(e){const t=Math.random()>.2;return{authNumber:`PA-2026-${Math.random().toString(36).substring(7).toUpperCase()}`,status:t?"approved":"pending",sbsCode:e,approvedAmount:t?Math.floor(Math.random()*5e4)+1e4:null,validFrom:new Date().toISOString().split("T")[0],validUntil:new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],notes:t?["Pre-authorization approved. Valid for 30 days."]:["Under review. Expected decision within 48 hours."],denialReason:null}}async checkPriorAuthStatus(e){await this.setAuthHeader();try{const t=await this.client.get(`/Claim?identifier=${e}`);return this.parsePriorAuthResponse(t.data.entry?.[0]?.resource)}catch(t){return console.error("Prior auth status check failed:",t),this.getMockPriorAuth(e)}}async submitClaim(e){await this.setAuthHeader();const t=this.buildClaimResource(e);try{const a=await this.client.post("/Claim",t);return this.parseClaimResponse(a.data)}catch(a){return console.error("Claim submission failed:",a),this.getMockClaimResponse(e)}}buildClaimResource(e){const t=e.items.map((a,i)=>({sequence:i+1,productOrService:{coding:[{system:"http://chi.gov.sa/sbs",code:a.sbsCode,display:a.description}]},servicedDate:a.serviceDate||e.serviceDate,quantity:{value:a.quantity||1},unitPrice:{value:a.unitPrice,currency:"SAR"},net:{value:a.netPrice||a.unitPrice*(a.quantity||1),currency:"SAR"}}));return{resourceType:"Claim",id:e.claimNumber||`CLM-${Date.now()}`,status:"active",type:{coding:[{system:"http://terminology.hl7.org/CodeSystem/claim-type",code:e.claimType||"institutional"}]},use:"claim",patient:{reference:`Patient/${e.patientId}`},created:new Date().toISOString(),provider:{reference:`Organization/${e.facilityId}`},priority:{coding:[{code:"normal"}]},insurance:[{sequence:1,focal:!0,coverage:{reference:`Coverage/${e.policyNumber}`}}],diagnosis:e.diagnoses?.map((a,i)=>({sequence:i+1,diagnosisCodeableConcept:{coding:[{system:"http://hl7.org/fhir/sid/icd-10",code:a.code,display:a.display}]}}))||[],item:t,total:{value:e.totalAmount,currency:"SAR"}}}parseClaimResponse(e){return{claimId:e.id,nphiesReference:e.identifier?.[0]?.value,status:this.mapClaimStatus(e.outcome),totalSubmitted:e.total?.value,totalApproved:e.payment?.amount?.value,processedDate:e.created,items:e.item?.map(t=>({sequence:t.sequence,status:t.adjudication?.find(a=>a.category?.coding?.[0]?.code==="submitted")?.reason?.coding?.[0]?.code,approvedAmount:t.adjudication?.find(a=>a.category?.coding?.[0]?.code==="benefit")?.amount?.value,denialReason:t.adjudication?.find(a=>a.category?.coding?.[0]?.code==="denial")?.reason?.coding?.[0]?.display})),errors:e.error?.map(t=>t.code?.text)||[]}}mapClaimStatus(e){return{queued:"submitted",complete:"approved",error:"rejected",partial:"partially_approved"}[e]||"pending"}getMockClaimResponse(e){const t=["approved","pending","partially_approved"],a=t[Math.floor(Math.random()*t.length)];return{claimId:e.claimNumber||`CLM-${Date.now()}`,nphiesReference:`NPHIES-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`,status:a,totalSubmitted:e.totalAmount,totalApproved:a==="approved"?e.totalAmount:a==="partially_approved"?e.totalAmount*.85:null,processedDate:new Date().toISOString(),items:e.items?.map((i,r)=>({sequence:r+1,status:a==="approved"?"approved":"pending",approvedAmount:a==="approved"?i.netPrice:null,denialReason:null})),errors:[]}}async checkClaimStatus(e){await this.setAuthHeader();try{const t=await this.client.get(`/ClaimResponse?request=${e}`);return this.parseClaimResponse(t.data.entry?.[0]?.resource)}catch(t){return console.error("Claim status check failed:",t),{claimId:e,status:"pending",message:"Unable to retrieve status. Please try again later."}}}detectBundles(e){const t=this.getAvailableBundles(),a=[];return t.forEach(i=>{const r=i.requiredCodes.filter(o=>e.includes(o)),n=r.length/i.requiredCodes.length*100;n>=60&&a.push({...i,matchedCodes:r,matchPercentage:n,savings:this.calculateBundleSavings(e,i)})}),{hasApplicableBundles:a.length>0,bundles:a,recommendedBundle:a.sort((i,r)=>r.savings-i.savings)[0]||null}}getAvailableBundles(){return[{id:"BUNDLE-KNEE-REPLACE",name:"Total Knee Replacement Bundle",totalPrice:45e3,requiredCodes:["49518-00-00","49518-01-00","49519-00-00","92514-00-00","95550-00-00"],description:"Complete knee replacement package including surgery, implants, and rehabilitation"},{id:"BUNDLE-CARDIAC-CATH",name:"Cardiac Catheterization Bundle",totalPrice:25e3,requiredCodes:["38200-00-00","38203-00-00","38218-00-00","11700-00-00"],description:"Diagnostic cardiac catheterization with angiography"},{id:"BUNDLE-LAPCHOL",name:"Laparoscopic Cholecystectomy Bundle",totalPrice:15e3,requiredCodes:["30443-00-00","30445-00-00","92514-00-00"],description:"Gallbladder removal surgery package"},{id:"BUNDLE-APPENDIX",name:"Appendectomy Bundle",totalPrice:12e3,requiredCodes:["30571-00-00","30572-00-00","92514-00-00"],description:"Appendix removal surgery package"},{id:"BUNDLE-MATERNITY",name:"Normal Delivery Package",totalPrice:12e3,requiredCodes:["16520-00-00","16520-01-00","90761-00-00"],description:"Standard vaginal delivery with routine care"}]}calculateBundleSavings(e,t){const a=e.length*5e3;return Math.max(0,a-t.totalPrice)}}const m=new u;export{m as n};
//# sourceMappingURL=nphiesService-CN9naE0r.js.map
