import{r as u,j as e}from"./vendor-react-MVSD7VGK.js";import{C as z,a as M,b as E}from"./Card-CNl4AdZD.js";import{S as te}from"./SectionHeader-BFZqpzku.js";import{B as b}from"./Button-BDY0gMZ-.js";import{A as v}from"./apiService-D97cca7l.js";import{u as se,i as S}from"./main-DTZYqsTu.js";import"./vendor-BW1Bdpst.js";const A={autoAcceptMarker:.85,reviewTrigger:.5,fuzzyNormalization:!0,universalSbsPriority:!0,strictIcd10Enforcement:!1};function ue({lang:i="en"}){const r=se(),t=(S[i]||S.en).pages?.mappingRules||S.en.pages.mappingRules,[l,o]=u.useState(A),[f,C]=u.useState(!0),[O,y]=u.useState(!1),[j,N]=u.useState([]),[I,$]=u.useState(!0),[B,T]=u.useState(!1),[d,g]=u.useState({facility_id:"1",internal_code:"",sbs_code:"",description:"",confidence:"1",notes:""}),[U,D]=u.useState(!1),[n,h]=u.useState({facility_id:"1",internal_code:"TEST_CODE",description:"Appendectomy removal with complications",loading:!1,result:null}),L=Math.round((Number(l.autoAcceptMarker||0)||0)*100),F=Math.round((Number(l.reviewTrigger||0)||0)*100),G=Math.max(F,L-1),x=u.useMemo(()=>{const s=Number(n?.result?.confidenceRatio||0);return s>=Number(l.autoAcceptMarker||.85)?"autoAccepted":s>=Number(l.reviewTrigger||.5)?"reviewRequired":"rejected"},[n?.result,l]),K=t.simulator.decisions[x]||x,W=async()=>{C(!0);try{const s=await v.getMappingConfig();if(!s?.success)throw new Error(s?.error||"Failed to load config");o({...A,...s.config||{}})}catch(s){r.warning(s?.message||t.toast.loadConfigFailed)}finally{C(!1)}},R=async()=>{$(!0);try{const s=await v.listMappingOverrides();if(!s?.success)throw new Error(s?.error||"Failed to load overrides");N(Array.isArray(s.overrides)?s.overrides:[])}catch(s){r.warning(s?.message||t.toast.loadOverridesFailed),N([])}finally{$(!1)}};u.useEffect(()=>{W(),R()},[]);const J=async()=>{y(!0);try{const s={autoAcceptMarker:l.autoAcceptMarker,reviewTrigger:l.reviewTrigger,fuzzyNormalization:!!l.fuzzyNormalization,universalSbsPriority:!!l.universalSbsPriority,strictIcd10Enforcement:!!l.strictIcd10Enforcement},a=await v.updateMappingConfig(s);if(!a?.success)throw new Error(a?.error||"Save failed");o({...A,...a.config||s}),r.success(t.toast.profileSaved)}catch(s){r.error(s?.message||t.toast.saveConfigFailed)}finally{y(!1)}},Q=async()=>{o(A),r.info(t.toast.defaultStaged)},V=async()=>{const s=String(d.internal_code||"").trim(),a=String(d.sbs_code||"").trim(),c=Number(d.facility_id||1),_=Number(d.confidence||1);if(!s||!a){r.error(t.toast.overrideRequired);return}D(!0);try{const w={facility_id:Number.isFinite(c)&&c>0?c:1,internal_code:s,sbs_code:a,description:String(d.description||"").trim()||null,confidence:Number.isFinite(_)?_:1,notes:String(d.notes||"").trim()||null},k=await v.createMappingOverride(w);if(!k?.success)throw new Error(k?.error||"Failed to save override");r.success(t.toast.overrideSaved),g({facility_id:"1",internal_code:"",sbs_code:"",description:"",confidence:"1",notes:""}),T(!1),await R()}catch(w){r.error(w?.message||t.toast.overrideSaveFailed)}finally{D(!1)}},X=async s=>{try{await v.deleteMappingOverride(String(s.internal_code||""),Number(s.facility_id||1)),r.success(t.toast.overrideDeleted),await R()}catch(a){r.error(a?.message||t.toast.deleteFailed)}},Y=async()=>{const s=String(n.internal_code||"").trim();if(!s){r.error(t.toast.internalCodeRequired);return}h(a=>({...a,loading:!0}));try{const a=Number(n.facility_id||1),c=await v.normalizeCode(s,String(n.description||"").trim(),Number.isFinite(a)?a:1),_=String(c?.sbs_mapped_code||c?.sbs_code||s).trim(),w=String(c?.official_description||c?.description||"").trim(),k=Math.max(0,Math.min(1,Number(c?.confidence||0)||0)),Z=String(c?.mapping_source||"normalizer");h(ee=>({...ee,loading:!1,result:{mappedCode:_,mappedDesc:w,confidenceRatio:k,confidencePct:Math.round(k*100),mappingSource:Z}}))}catch{h(c=>({...c,loading:!1,result:{mappedCode:t.simulator.resolutionError,mappedDesc:"",confidenceRatio:0,confidencePct:0,mappingSource:"error"}}))}};return e.jsx("div",{className:"flex-1",children:e.jsxs("main",{className:"max-w-[1400px] mx-auto p-6 sm:p-8 space-y-8 stagger-children",children:[e.jsx("section",{className:"animate-premium-in",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end justify-between gap-6",children:[e.jsx(te,{title:t.header.title,subtitle:t.header.subtitle,badge:f?t.header.badgeLoading:t.header.badgeLive}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(b,{variant:"secondary",icon:"history",onClick:()=>r.info(t.toast.versionHistoryUnavailable),children:t.actions.versionHistory}),e.jsx(b,{variant:"secondary",icon:"restore",onClick:Q,"data-testid":"mappingrules-reset",children:t.actions.reset}),e.jsx(b,{icon:"save",loading:O,onClick:J,"data-testid":"mappingrules-save",children:t.actions.save})]})]})}),e.jsxs("div",{className:"grid lg:grid-cols-12 gap-8",children:[e.jsxs("div",{className:"lg:col-span-5 space-y-8 animate-premium-in",style:{animationDelay:"100ms"},children:[e.jsxs(z,{children:[e.jsx(M,{title:t.thresholds.title,subtitle:t.thresholds.subtitle}),e.jsxs(E,{className:"space-y-10 py-6",children:[e.jsx(H,{testId:"mappingrules-autoaccept",unit:"%",label:t.thresholds.autoAccept.label,val:L,min:60,max:99,color:"emerald",hint:t.thresholds.autoAccept.hint,onChange:s=>o(a=>({...a,autoAcceptMarker:q(s/100)}))}),e.jsx(H,{testId:"mappingrules-reviewtrigger",unit:"%",label:t.thresholds.reviewTrigger.label,val:F,min:0,max:95,color:"amber",hint:t.thresholds.reviewTrigger.hint,onChange:s=>o(a=>({...a,reviewTrigger:q(s/100)}))}),e.jsxs("div",{className:"p-6 bg-blue-600/5 rounded-[28px] border border-blue-600/10 flex gap-4",children:[e.jsx("span",{className:"material-symbols-outlined text-blue-600 font-black",children:"info"}),e.jsx("p",{className:"text-xs font-bold text-slate-500 leading-relaxed",children:t.thresholds.infoTemplate.replace("{review}",String(F)).replace("{auto}",String(G))})]})]})]}),e.jsxs(z,{children:[e.jsx(M,{title:t.heuristics.title,subtitle:t.heuristics.subtitle}),e.jsxs(E,{className:"p-0",children:[e.jsx(P,{testId:"mappingrules-toggle-fuzzy",label:t.heuristics.toggles.fuzzy.label,sub:t.heuristics.toggles.fuzzy.desc,active:!!l.fuzzyNormalization,onToggle:()=>o(s=>({...s,fuzzyNormalization:!s.fuzzyNormalization})),lang:i}),e.jsx(P,{testId:"mappingrules-toggle-universal",label:t.heuristics.toggles.universal.label,sub:t.heuristics.toggles.universal.desc,active:!!l.universalSbsPriority,onToggle:()=>o(s=>({...s,universalSbsPriority:!s.universalSbsPriority})),lang:i}),e.jsx(P,{testId:"mappingrules-toggle-icd10",label:t.heuristics.toggles.icd10.label,sub:t.heuristics.toggles.icd10.desc,active:!!l.strictIcd10Enforcement,onToggle:()=>o(s=>({...s,strictIcd10Enforcement:!s.strictIcd10Enforcement})),lang:i})]})]})]}),e.jsxs("div",{className:"lg:col-span-7 space-y-8 animate-premium-in",style:{animationDelay:"200ms"},children:[e.jsxs(z,{className:"flex flex-col",children:[e.jsx(M,{title:t.overrides.title,subtitle:t.overrides.subtitle,action:e.jsx(b,{variant:"secondary",size:"sm",icon:"add","data-testid":"mappingrules-open-override-editor",onClick:()=>T(s=>!s),children:t.overrides.add})}),e.jsxs(E,{className:"p-0",children:[B&&e.jsxs("div",{className:"p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50/40 dark:bg-slate-900/20",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(p,{label:t.overrides.editor.facilityId,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-bold","data-testid":"mappingrules-override-facility",value:d.facility_id,onChange:s=>g(a=>({...a,facility_id:s.target.value}))})}),e.jsx(p,{label:t.overrides.editor.confidence,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-bold","data-testid":"mappingrules-override-confidence",value:d.confidence,onChange:s=>g(a=>({...a,confidence:s.target.value}))})}),e.jsx(p,{label:t.overrides.editor.internalCode,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-black font-mono text-blue-600","data-testid":"mappingrules-override-internal",value:d.internal_code,onChange:s=>g(a=>({...a,internal_code:s.target.value}))})}),e.jsx(p,{label:t.overrides.editor.mappedSbsCode,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-black font-mono text-blue-600","data-testid":"mappingrules-override-sbs",value:d.sbs_code,onChange:s=>g(a=>({...a,sbs_code:s.target.value}))})}),e.jsx(p,{label:t.overrides.editor.description,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-bold","data-testid":"mappingrules-override-description",value:d.description,onChange:s=>g(a=>({...a,description:s.target.value}))})}),e.jsx(p,{label:t.overrides.editor.notes,children:e.jsx("input",{className:"w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl px-4 py-3 text-sm font-bold","data-testid":"mappingrules-override-notes",value:d.notes,onChange:s=>g(a=>({...a,notes:s.target.value}))})})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-3",children:[e.jsx(b,{variant:"secondary",icon:"close",onClick:()=>T(!1),children:t.overrides.editor.cancel}),e.jsx(b,{icon:"verified",loading:U,"data-testid":"mappingrules-override-save",onClick:V,children:t.overrides.editor.save})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{"data-testid":"mappingrules-overrides-table",className:"w-full text-left",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-900/40",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-[10px] font-black uppercase text-slate-500",children:t.overrides.table.facility}),e.jsx("th",{className:"px-6 py-4 text-[10px] font-black uppercase text-slate-500",children:t.overrides.table.internal}),e.jsx("th",{className:"px-6 py-4 text-[10px] font-black uppercase text-slate-500",children:t.overrides.table.sbs}),e.jsx("th",{className:"px-6 py-4 text-[10px] font-black uppercase text-slate-500 text-right",children:t.overrides.table.conf}),e.jsx("th",{className:"px-6 py-4"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 dark:divide-slate-800",children:I?e.jsx("tr",{children:e.jsx("td",{className:"px-6 py-10 text-center text-xs font-bold text-slate-400",colSpan:5,children:t.overrides.table.loading})}):j.length===0?e.jsx("tr",{children:e.jsx("td",{className:"px-6 py-10 text-center text-xs font-bold text-slate-400",colSpan:5,children:t.overrides.table.empty})}):j.map(s=>e.jsx(ae,{row:s,onDelete:()=>X(s),t},`${s.facility_id}|${s.internal_code}`))})]})})]})]}),e.jsxs(z,{className:"bg-slate-900 text-white overflow-hidden relative",children:[e.jsx("div",{className:"absolute top-0 right-0 p-8 opacity-10 pointer-events-none",children:e.jsx("span",{className:"material-symbols-outlined text-[100px] font-black",children:"biotech"})}),e.jsx(M,{title:t.simulator.title,subtitle:t.simulator.subtitle}),e.jsxs(E,{className:"space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsx(p,{label:t.simulator.fields.facilityId,children:e.jsx("input",{className:"w-full bg-slate-950/50 border border-white/10 rounded-2xl px-4 py-3 text-sm font-bold text-white focus:outline-none","data-testid":"mappingrules-sim-facility",value:n.facility_id,onChange:s=>h(a=>({...a,facility_id:s.target.value}))})}),e.jsx(p,{label:t.simulator.fields.internalCode,children:e.jsx("input",{className:"w-full bg-slate-950/50 border border-white/10 rounded-2xl px-4 py-3 text-sm font-black font-mono text-white focus:outline-none","data-testid":"mappingrules-sim-internal",value:n.internal_code,onChange:s=>h(a=>({...a,internal_code:s.target.value}))})}),e.jsx(p,{label:t.simulator.fields.description,children:e.jsx("input",{className:"w-full bg-slate-950/50 border border-white/10 rounded-2xl px-4 py-3 text-sm font-bold text-white focus:outline-none","data-testid":"mappingrules-sim-description",value:n.description,onChange:s=>h(a=>({...a,description:s.target.value})),placeholder:t.simulator.fields.descriptionPlaceholder})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(b,{loading:n.loading,icon:"play_arrow",className:"py-3.5 px-8","data-testid":"mappingrules-simulate",onClick:Y,children:t.simulator.actions.simulate})}),e.jsxs("div",{className:"glass-panel p-8 rounded-[32px] border border-white/5 relative overflow-hidden flex flex-col sm:flex-row gap-8",children:[e.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-2 ${x==="autoAccepted"?"bg-emerald-500":x==="reviewRequired"?"bg-amber-500":"bg-rose-500"}`}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest text-slate-500",children:t.simulator.output.predicted}),e.jsx("h4",{className:`text-2xl font-black tracking-tight ${n.loading?"animate-pulse opacity-50":""}`,"data-testid":"mappingrules-sim-mapped",children:n.result?.mappedCode||"—"}),e.jsxs("p",{className:"text-[11px] font-bold text-slate-300/80","data-testid":"mappingrules-sim-source",children:[t.simulator.output.sourceLabel,": ",n.result?.mappingSource||"—"]})]}),e.jsxs("div",{className:"text-center sm:text-right space-y-2",children:[e.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest text-slate-500",children:t.simulator.output.confidenceLabel}),e.jsx("h4",{className:`text-3xl font-black tracking-tighter ${x==="autoAccepted"?"text-emerald-500":x==="reviewRequired"?"text-amber-500":"text-rose-500"}`,"data-testid":"mappingrules-sim-confidence",children:n.result?`${n.result.confidencePct}%`:"—"})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs("span",{className:`text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full border border-white/10 ${x==="autoAccepted"?"text-emerald-500 bg-emerald-500/5":x==="reviewRequired"?"text-amber-500 bg-amber-500/5":"text-rose-500 bg-rose-500/5"}`,"data-testid":"mappingrules-sim-decision",children:[t.simulator.output.resultLabel,": ",K]})})]})]})]})]})]})})}function q(i){const r=Number(i);return Number.isFinite(r)?Math.max(0,Math.min(1,r)):0}function p({label:i,children:r}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase tracking-widest text-slate-500",style:{marginInlineStart:"0.25rem"},children:i}),r]})}function H({testId:i,label:r,val:m,min:t,max:l,color:o,unit:f,hint:C,onChange:O}){const y={emerald:"accent-emerald-500 text-emerald-600",amber:"accent-amber-500 text-amber-600"},j=y[o]||y.emerald,N=Number.isFinite(Number(m))?Number(m):0;return e.jsxs("div",{className:"space-y-4","data-testid":i,children:[e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm font-black text-slate-800 dark:text-gray-100 leading-none",children:r}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:C})]}),e.jsxs("span",{className:`text-xl font-black ${j.split(" ")[1]}`,children:[N,f]})]}),e.jsx("input",{type:"range",className:`w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full appearance-none transition-all ${j.split(" ")[0]}`,min:t,max:l,value:N,onChange:I=>O?.(Number(I.target.value))})]})}function P({testId:i,label:r,sub:m,active:t,onToggle:l,lang:o="en"}){const f=S[o]||S.en;return e.jsxs("button",{type:"button","data-testid":i,onClick:l,role:"switch","aria-checked":!!t,"aria-label":`${r}: ${t?f.common.on:f.common.off}`,className:"w-full text-left flex items-center justify-between px-8 py-5 border-b border-slate-100 dark:border-slate-800 last:border-0 hover:bg-slate-50/50 dark:hover:bg-slate-800/20 transition-colors",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-sm font-bold text-slate-800 dark:text-gray-100",children:r}),e.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:m})]}),e.jsx("div",{className:`w-10 h-5 rounded-full transition-colors relative ${t?"bg-blue-600":"bg-slate-200 dark:bg-slate-700"}`,children:e.jsx("div",{className:"absolute top-1 size-3 bg-white rounded-full transition-all",style:t?{insetInlineEnd:"0.25rem"}:{insetInlineStart:"0.25rem"}})})]})}function ae({row:i,onDelete:r,t:m}){const t=Math.round((Number(i.confidence||0)||0)*100);return e.jsxs("tr",{className:"group hover:bg-slate-50/50 dark:hover:bg-slate-800/20 transition-all duration-300",children:[e.jsx("td",{className:"px-6 py-5",children:e.jsx("p",{className:"text-sm font-bold text-slate-800 dark:text-white leading-none",children:i.facility_id})}),e.jsx("td",{className:"px-6 py-5",children:e.jsx("p",{className:"text-xs font-black font-mono text-blue-600",children:i.internal_code})}),e.jsx("td",{className:"px-6 py-5",children:e.jsx("p",{className:"text-xs font-black font-mono text-slate-700 dark:text-slate-200",children:i.sbs_code})}),e.jsx("td",{className:"px-6 py-5 text-right",children:e.jsxs("span",{className:"text-xs font-black text-slate-400",children:[t,"%"]})}),e.jsx("td",{className:"px-6 py-5 text-right",children:e.jsx("button",{type:"button",className:"text-slate-300 hover:text-rose-500 transition-colors",onClick:r,title:m.overrides.row.delete,"aria-label":m.overrides.row.delete,children:e.jsx("span",{className:"material-symbols-outlined text-lg",children:"delete"})})})]})}export{ue as MappingRulesConfig};
//# sourceMappingURL=MappingRulesConfig-BCUgpC-P.js.map
