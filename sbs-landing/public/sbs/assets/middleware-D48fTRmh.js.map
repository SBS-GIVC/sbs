{"version":3,"file":"middleware-D48fTRmh.js","sources":["../../src/utils/middleware.js"],"sourcesContent":["// Middleware Logic - SBS Code Normalization and FHIR Processing\nimport { callGemini } from '../services/geminiService';\nimport { APIService } from '../services/apiService';\nimport sbsCodesData from '../data/sbs_codes.json';\n\n// Official CHI SBS Codes Database (V3.1)\nconst SBS_OFFICIAL_CODES = sbsCodesData.codes;\n\n// Local mapping database for quick lookups (facility-specific codes to SBS codes)\n// This maps internal hospital codes to official SBS codes\nconst MAPPING_DB = {\n  // Laboratory Services\n  \"LAB_001\": { sbs_code: \"55707-01-00\", desc: \"Complete Blood Count (CBC)\", fee: 150 },\n  \"LAB_CBC\": { sbs_code: \"55707-01-00\", desc: \"Full blood examination - automated\", fee: 150 },\n  \"LAB_CMP\": { sbs_code: \"66500-00-00\", desc: \"Comprehensive Metabolic Panel\", fee: 280 },\n  \"LAB_LIPID\": { sbs_code: \"66503-00-00\", desc: \"Lipid Profile Panel\", fee: 200 },\n  \"LAB_HBA1C\": { sbs_code: \"66512-00-00\", desc: \"Glycated Haemoglobin (HbA1c)\", fee: 120 },\n  \"LAB_TSH\": { sbs_code: \"66716-00-00\", desc: \"Thyroid Stimulating Hormone\", fee: 180 },\n  \"LAB_FT4\": { sbs_code: \"66719-00-00\", desc: \"Free Thyroxine (FT4)\", fee: 160 },\n  \"LAB_UA\": { sbs_code: \"65993-00-00\", desc: \"Urinalysis\", fee: 80 },\n  \n  // Consultation Services\n  \"CONS_99\": { sbs_code: \"10954-01-00\", desc: \"Consultation - Consultant Physician\", fee: 400 },\n  \"CONS_GP\": { sbs_code: \"10951-00-00\", desc: \"General Practice Consultation\", fee: 200 },\n  \"CONS_SPEC\": { sbs_code: \"10954-00-00\", desc: \"Specialist Consultation\", fee: 350 },\n  \"CONS_FOLLOWUP\": { sbs_code: \"10953-00-00\", desc: \"Follow-up Consultation\", fee: 150 },\n  \n  // Imaging Services\n  \"RAD_XRAY_CHEST\": { sbs_code: \"58500-00-00\", desc: \"X-ray Chest PA\", fee: 200 },\n  \"RAD_CT_HEAD\": { sbs_code: \"56001-00-00\", desc: \"CT Scan Head without contrast\", fee: 800 },\n  \"RAD_MRI_BRAIN\": { sbs_code: \"56401-00-00\", desc: \"MRI Brain without contrast\", fee: 1500 },\n  \"RAD_US_ABD\": { sbs_code: \"55036-00-00\", desc: \"Ultrasound Abdomen Complete\", fee: 400 },\n  \n  // Surgical Procedures\n  \"SURG_APPY\": { sbs_code: \"30571-00-00\", desc: \"Appendectomy - Laparoscopic\", fee: 8000 },\n  \"SURG_CHOLE\": { sbs_code: \"30443-00-00\", desc: \"Cholecystectomy - Laparoscopic\", fee: 10000 },\n  \"SURG_HERNIA\": { sbs_code: \"30609-00-00\", desc: \"Hernia Repair - Inguinal\", fee: 6000 },\n  \n  // Emergency Services\n  \"ER_VISIT\": { sbs_code: \"10960-00-00\", desc: \"Emergency Department Visit\", fee: 500 },\n  \"ER_TRAUMA\": { sbs_code: \"10961-00-00\", desc: \"Emergency Trauma Assessment\", fee: 800 },\n  \n  // Cardiology\n  \"CARDIO_ECG\": { sbs_code: \"11700-00-00\", desc: \"Electrocardiogram (ECG)\", fee: 150 },\n  \"CARDIO_ECHO\": { sbs_code: \"55113-00-00\", desc: \"Echocardiography\", fee: 600 },\n  \"CARDIO_HOLTER\": { sbs_code: \"11709-00-00\", desc: \"Holter Monitor 24hr\", fee: 400 },\n  \n  // Respiratory\n  \"RESP_SPIROMETRY\": { sbs_code: \"11503-00-00\", desc: \"Spirometry\", fee: 200 },\n  \"RESP_PFT\": { sbs_code: \"11512-00-00\", desc: \"Pulmonary Function Test Complete\", fee: 450 },\n  \n  // Dental (using official dental prices)\n  \"DENTAL_EXAM\": { sbs_code: \"97011-00-00\", desc: \"Dental Examination\", fee: 100 },\n  \"DENTAL_CLEANING\": { sbs_code: \"97112-00-00\", desc: \"Dental Prophylaxis\", fee: 150 },\n  \"DENTAL_FILLING\": { sbs_code: \"97215-00-00\", desc: \"Dental Filling - Composite\", fee: 200 },\n  \"DENTAL_EXTRACT\": { sbs_code: \"97311-00-00\", desc: \"Tooth Extraction - Simple\", fee: 180 },\n  \n  // Physiotherapy\n  \"PT_INIT\": { sbs_code: \"95550-00-00\", desc: \"Physiotherapy Initial Assessment\", fee: 250 },\n  \"PT_FOLLOWUP\": { sbs_code: \"95551-00-00\", desc: \"Physiotherapy Follow-up\", fee: 150 },\n  \"PT_EXERCISE\": { sbs_code: \"95560-00-00\", desc: \"Therapeutic Exercise\", fee: 120 },\n};\n\n/**\n * Search for SBS code by keyword in official database\n */\nexport function searchSBSCodes(keyword, limit = 10) {\n  const results = [];\n  const keywordLower = keyword.toLowerCase();\n  \n  for (const [code, data] of Object.entries(SBS_OFFICIAL_CODES)) {\n    if (\n      code.toLowerCase().includes(keywordLower) ||\n      data.desc.toLowerCase().includes(keywordLower) ||\n      data.category.toLowerCase().includes(keywordLower)\n    ) {\n      results.push({ code, ...data });\n      if (results.length >= limit) break;\n    }\n  }\n  \n  return results;\n}\n\n/**\n * Get SBS code details from official database\n */\nexport function getSBSCodeDetails(sbsCode) {\n  return SBS_OFFICIAL_CODES[sbsCode] || null;\n}\n\n/**\n * Normalize internal hospital codes to SBS codes\n * Uses local DB first, then AI fallback, then backend service\n */\nexport async function normalizeCode(internalCode, description, lang = 'en') {\n  // Check local mapping first\n  if (MAPPING_DB[internalCode]) {\n    return {\n      ...MAPPING_DB[internalCode],\n      source: \"Local DB\",\n      confidence: 1.0,\n      rationale: lang === 'ar'\n        ? \"مطابقة مباشرة من قاعدة بيانات المنشأة.\"\n        : \"Direct static match from facility database.\"\n    };\n  }\n\n  // Try backend normalization service\n  try {\n    const result = await APIService.normalizeCode(internalCode, description);\n\n    if (result && result.sbs_code) {\n      return {\n        sbs_code: result.sbs_code,\n        desc: result.description || description,\n        fee: result.estimated_fee || 300,\n        source: \"SBS Engine\",\n        confidence: result.confidence || 0.9,\n        rationale: result.rationale || (lang === 'ar'\n          ? \"تم التعيين من محرك SBS.\"\n          : \"Mapped via SBS normalization engine.\")\n      };\n    }\n  } catch (backendError) {\n    console.warn('Backend normalization failed, trying AI fallback:', backendError);\n  }\n\n  // Fallback to AI-based normalization\n  try {\n    // Sanitize inputs to prevent prompt injection\n    const sanitizedCode = internalCode.replace(/[`'\"\\\\]/g, '').substring(0, 50);\n    const sanitizedDesc = description.replace(/[`'\"\\\\]/g, '').substring(0, 200);\n    \n    const aiResponse = await callGemini(\n      `Map hospital service to SBS code.\n       Code: ${sanitizedCode} | Desc: ${sanitizedDesc} | Lang: ${lang === 'ar' ? 'Arabic' : 'English'}\n       Return ONLY JSON: {\"code\": \"SBS-XXX-000\", \"desc\": \"Official Name\", \"confidence\": 0.85, \"rationale\": \"Explanation\"}`,\n      \"You are a Senior Saudi Medical Coder. Strict JSON output only.\"\n    );\n\n    if (!aiResponse) throw new Error(\"Empty AI Response\");\n\n    const cleanJson = aiResponse.replace(/```json|```/g, \"\").trim();\n    let parsed;\n    try {\n      parsed = JSON.parse(cleanJson);\n      \n      // Validate required fields and types\n      if (!parsed || typeof parsed !== 'object') {\n        throw new Error('Invalid JSON structure');\n      }\n      \n      // Ensure required fields exist and are strings\n      if (!parsed.code || typeof parsed.code !== 'string') {\n        parsed.code = \"SBS-PENDING\";\n      }\n      \n      if (!parsed.desc || typeof parsed.desc !== 'string') {\n        parsed.desc = description;\n      }\n      \n      // Validate confidence is a number between 0 and 1\n      if (typeof parsed.confidence !== 'number' || parsed.confidence < 0 || parsed.confidence > 1) {\n        parsed.confidence = 0.7;\n      }\n      \n    } catch (jsonError) {\n      console.error(\"JSON parsing failed:\", jsonError);\n      throw new Error(\"Invalid AI response format\");\n    }\n\n    return {\n      sbs_code: parsed.code || \"SBS-PENDING\",\n      desc: parsed.desc || description,\n      fee: 300,\n      source: \"Agentic AI ✨\",\n      confidence: parsed.confidence || 0.7,\n      rationale: parsed.rationale || (lang === 'ar'\n        ? \"تم التعيين بناءً على الوصف السريري.\"\n        : \"Assigned based on clinical context.\")\n    };\n  } catch (e) {\n    console.error(\"Normalization Error:\", e);\n    return {\n      sbs_code: \"SBS-MISC-99\",\n      desc: description,\n      fee: 0,\n      source: \"Manual Review Required\",\n      confidence: 0,\n      rationale: \"AI engine could not resolve code safely.\"\n    };\n  }\n}\n\n/**\n * Build FHIR R4 Claim resource and apply financial rules\n */\nexport function buildFHIRAndApplyRules(items) {\n  const accreditationMarkup = 1.15; // 15% Markup for GIVC-SBS standard\n  const total = items.reduce((acc, curr) => acc + (curr.fee * accreditationMarkup), 0);\n\n  return {\n    resourceType: \"Claim\",\n    id: `givc-sbs-clm-${Date.now()}`,\n    status: \"active\",\n    type: {\n      coding: [{\n        system: \"http://terminology.hl7.org/CodeSystem/claim-type\",\n        code: \"professional\"\n      }]\n    },\n    use: \"claim\",\n    patient: {\n      reference: \"Patient/example\"\n    },\n    created: new Date().toISOString(),\n    provider: {\n      reference: \"Organization/GIVC-SBS\"\n    },\n    priority: {\n      coding: [{\n        code: \"normal\"\n      }]\n    },\n    items: items.map((it, index) => ({\n      sequence: index + 1,\n      productOrService: {\n        coding: [{\n          system: \"http://sbs.moh.gov.sa\",\n          code: it.sbs_code,\n          display: it.desc\n        }]\n      },\n      unitPrice: {\n        value: it.fee,\n        currency: \"SAR\"\n      },\n      net: {\n        value: Math.round(it.fee * accreditationMarkup),\n        currency: \"SAR\"\n      },\n      ...it\n    })),\n    total: {\n      value: Math.round(total),\n      currency: \"SAR\"\n    }\n  };\n}\n"],"names":["SBS_OFFICIAL_CODES","sbsCodesData","MAPPING_DB","searchSBSCodes","keyword","limit","results","keywordLower","code","data","normalizeCode","internalCode","description","lang","result","APIService","backendError","sanitizedCode","sanitizedDesc","aiResponse","callGemini","cleanJson","parsed","jsonError"],"mappings":"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"}